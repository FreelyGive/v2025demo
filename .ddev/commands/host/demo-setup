#!/usr/bin/env sh

## Description: Wrapper around the normal rebuild function with added stuff.
## Usage: demo-setup
## Example: "ddev demo-setup"

if [ "$(ddev list | grep v2025demo | grep OK)" ]; then
  read -p "v2025demo is running, do you want to delete it and re-setup? (y/n) " -n 1 -r
  echo    # (optional) move to a new line
  if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "Deleting v2025demo"
  else
    echo "Exiting setup-demo"
    exit 1
  fi
fi

# Delete garbage
ddev delete -O -y
rm -rf vendor web composer.* patches.lock.json

# Drupal CMS
ddev start

# Install
ddev drush si -y --account-pass=admin --site-name="2025 Demo"
# Install a empty demo page with Canvas
ddev drush recipe ../custom_recipes/new_canvas_page
# Composer stuff
ddev composer require 'drupal/ai:1.2.x-dev@dev' 'drupal/ai_agents:1.2.x-dev@dev' 'drupal/ai_provider_openai:1.2.x-dev@dev' 'drupal/ai_vdb_provider_milvus:1.1.x-dev@dev'
# Install the AI stuff.
ddev drush recipe ../custom_recipes/canvas_ai_setup

# Always flush the cache
ddev drush cr

echo "Visit https://v2025demo.ddev.site/canvas/canvas_page/2/editor and login with user 'admin' and password 'admin' to see the demo page."
echo "After login, you click "New" and "New Page" to create a new page from AI."
